import streamlit as st
import pandas as pd
import numpy as np

st.set_page_config(page_title="FT Grand Compte", page_icon="üöö", layout="wide")

# ---------- CHARGEMENT DES DONN√âES ----------

@st.cache_data
def load_data():
    xls = pd.ExcelFile("bdd_CG.xlsx")

    # 1 ligne par v√©hicule
    vehicules = pd.read_excel(xls, "FS_referentiel_produits_std_Ver")

    cabines = pd.read_excel(xls, "CABINES")
    moteurs = pd.read_excel(xls, "MOTEURS")
    chassis = pd.read_excel(xls, "CHASSIS")
    caisses = pd.read_excel(xls, "CAISSES")
    frigo = pd.read_excel(xls, "FRIGO")
    hayons = pd.read_excel(xls, "HAYONS")

    return vehicules, cabines, moteurs, chassis, caisses, frigo, hayons


vehicules, cabines, moteurs, chassis, caisses, frigo, hayons = load_data()

st.title("G√©n√©rateur de Fiches Techniques Grand Compte")
st.caption("V1 ‚Äì Base de test √† partir de `bdd_CG.xlsx`")

# ---------- FONCTION UTILITAIRE POUR LES FILTRES ----------

def filtre_select(df, col, label):
    """Cr√©e un selectbox 'Tous + valeurs uniques' et renvoie le DF filtr√© + la valeur choisie."""
    if col not in df.columns:
        st.error(f"Colonne manquante dans la base : {col}")
        return df, None

    options = sorted([v for v in df[col].dropna().unique().tolist() if str(v).strip() != ""])
    options_display = ["Tous"] + options
    choix = st.selectbox(label, options_display)

    if choix != "Tous":
        df = df[df[col] == choix]

    return df, choix

# ---------- BARRE LAT√âRALE : FILTRES V√âHICULE ----------

st.sidebar.header("Filtres v√©hicule")

df_filtre = vehicules.copy()

df_filtre, code_pays = filtre_select(df_filtre, "code_pays", "Code pays")
df_filtre, marque    = filtre_select(df_filtre, "Marque", "Marque")
df_filtre, modele    = filtre_select(df_filtre, "Modele", "Mod√®le")
df_filtre, code_pf   = filtre_select(df_filtre, "Code_PF", "Code PF")
df_filtre, std_pf    = filtre_select(df_filtre, "Standard_PF", "Standard PF")

# Filtres sur les codes de composants (facultatifs)
df_filtre, cab_code   = filtre_select(df_filtre, "C_Cabine", "Cabine")
df_filtre, ch_code    = filtre_select(df_filtre, "C_Chassis", "Ch√¢ssis")
df_filtre, caisse_code = filtre_select(df_filtre, "C_Caisse", "Caisse")
df_filtre, mot_code   = filtre_select(df_filtre, "M_moteur", "Moteur")
df_filtre, gf_code    = filtre_select(df_filtre, "C_Groupe frigo", "Groupe frigorifique")
df_filtre, hay_code   = filtre_select(df_filtre, "C_Hayon elevateur", "Hayon √©l√©vateur")

st.subheader("R√©sultats du filtrage")
st.write(f"{len(df_filtre)} combinaison(s) v√©hicule trouv√©e(s).")

if df_filtre.empty:
    st.warning("Aucun v√©hicule ne correspond aux filtres s√©lectionn√©s.")
    st.stop()

# ---------- CHOIX DE LA LIGNE V√âHICULE ----------

def format_vehicule(row):
    return f"{row['code_pays']} ‚Äì {row['Marque']} {row['Modele']} ‚Äì {row['Code_PF']} ({row['Standard_PF']})"

indices = list(df_filtre.index)
choix_idx = st.selectbox(
    "S√©lectionne le v√©hicule pour g√©n√©rer la FT :",
    indices,
    format_func=lambda i: format_vehicule(df_filtre.loc[i]),
)

veh = df_filtre.loc[choix_idx]

st.markdown("---")
st.subheader("Synth√®se v√©hicule")

colonnes_synthese = [
    "code_pays",
    "Marque",
    "Modele",
    "Code_PF",
    "Standard_PF",
    "catalogue_1\n PF",
    "catalogue_2\nST",
    "catalogue_3\n LIBRE",
]

cols_existantes = [c for c in colonnes_synthese if c in veh.index]
st.table(veh[cols_existantes].to_frame(name="Valeur"))

# ---------- IMAGES (si pr√©sentes dans la base) ----------

image_cols = [c for c in ["Image Vehicule", "Image Client", "Image Carburant"] if c in veh.index]

if image_cols:
    st.subheader("Images associ√©es")
    img_cols = st.columns(len(image_cols))
    for col_name, col_st in zip(image_cols, img_cols):
        url = veh[col_name]
        if isinstance(url, str) and url.strip():
            with col_st:
                st.caption(col_name)
                st.image(url)
        else:
            with col_st:
                st.caption(col_name)
                st.info("Pas d'image d√©finie.")

# ---------- FONCTION D'AFFICHAGE DES COMPOSANTS ----------

def affiche_composant(titre, code, df_ref, col_code_ref):
    st.markdown("---")
    st.subheader(titre)

    if pd.isna(code) or str(code).strip() == "":
        st.info("Aucun code renseign√© pour ce composant.")
        return

    st.write(f"Code composant : **{code}**")

    # recherche dans la base de r√©f√©rence
    comp = df_ref[df_ref[col_code_ref] == code]

    if comp.empty:
        st.warning("Code non trouv√© dans la base de r√©f√©rence.")
        return

    # On ne garde qu'une ligne (normalement unique)
    comp_row = comp.iloc[0].dropna()
    st.table(comp_row.to_frame(name="Valeur"))

# ---------- D√âTAILS DES COMPOSANTS POUR LA FT ----------

affiche_composant("Cabine", veh.get("C_Cabine"), cabines, "C_Cabine")
affiche_composant("Ch√¢ssis", veh.get("C_Chassis"), chassis, "c_chassis")
affiche_composant("Caisse", veh.get("C_Caisse"), caisses, "c_caisse")
affiche_composant("Moteur", veh.get("M_moteur"), moteurs, "M_moteur")
affiche_composant("Groupe frigorifique", veh.get("C_Groupe frigo"), frigo, "c_groupe frigo")
affiche_composant("Hayon √©l√©vateur", veh.get("C_Hayon elevateur"), hayons, "c_hayon elevateur")

st.markdown("---")
st.success("Toutes ces informations pourront ensuite √™tre mapp√©es sur ton mod√®le de fiche technique PF (Word/Excel/etc.).")
